<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîî Notifications - SignalTrust AI</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .notifications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .notification-stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .stat-item {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            flex: 1;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gold-primary);
        }
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        .notification-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }
        .filter-btn.active {
            background: var(--gold-primary);
            color: var(--bg-dark);
            border-color: var(--gold-primary);
        }
        .notification-item {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            transition: all 0.3s;
            position: relative;
        }
        .notification-item.unread {
            border-left: 4px solid var(--gold-primary);
            background: rgba(255, 215, 0, 0.05);
        }
        .notification-item:hover {
            border-color: var(--gold-primary);
            transform: translateX(5px);
        }
        .notif-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        .notif-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .notif-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .notif-message {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .notif-actions {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
        }
        .notif-action {
            color: var(--gold-primary);
            cursor: pointer;
            text-decoration: none;
        }
        .notif-action:hover {
            text-decoration: underline;
        }
        .priority-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .priority-critical { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .priority-high { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .priority-medium { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .priority-low { background: rgba(107, 114, 128, 0.2); color: #6b7280; }
        .type-icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    {% include 'partials/nav.html' %}
    
    <div class="container" style="padding: 2rem 0;">
        <div class="notifications-header">
            <h1>üîî Notification Center</h1>
            <div>
                <button class="btn btn-outline" onclick="markAllAsRead()">
                    ‚úì Mark All Read
                </button>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="notification-stats">
            <div class="stat-item">
                <div class="stat-number" id="totalNotifs">0</div>
                <div class="stat-label">Total Notifications</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="unreadNotifs">0</div>
                <div class="stat-label">Unread</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="todayNotifs">0</div>
                <div class="stat-label">Today</div>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="notification-filters">
            <button class="filter-btn active" data-filter="all" onclick="filterNotifications('all')">
                All
            </button>
            <button class="filter-btn" data-filter="unread" onclick="filterNotifications('unread')">
                Unread
            </button>
            <button class="filter-btn" data-filter="price_alert" onclick="filterNotifications('price_alert')">
                üí∞ Price Alerts
            </button>
            <button class="filter-btn" data-filter="whale_movement" onclick="filterNotifications('whale_movement')">
                üêã Whale Alerts
            </button>
            <button class="filter-btn" data-filter="ai_insight" onclick="filterNotifications('ai_insight')">
                ü§ñ AI Insights
            </button>
            <button class="filter-btn" data-filter="trade_signal" onclick="filterNotifications('trade_signal')">
                üìä Trade Signals
            </button>
        </div>
        
        <!-- Notifications List -->
        <div id="notificationsList">
            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                Loading notifications...
            </div>
        </div>
    </div>
    
    <script>
        // Get user info
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const userId = user.user_id || '';
        
        let allNotifications = [];
        let currentFilter = 'all';
        
        // Load notifications on page load
        loadNotifications();
        
        async function loadNotifications() {
            try {
                const response = await fetch(`/api/notifications?user_id=${userId}&limit=50`);
                const data = await response.json();
                
                if (data.success) {
                    allNotifications = data.notifications;
                    updateStats(data.stats);
                    displayNotifications(allNotifications);
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }
        
        function updateStats(stats) {
            document.getElementById('totalNotifs').textContent = stats.total || 0;
            document.getElementById('unreadNotifs').textContent = stats.unread || 0;
            
            // Calculate today's notifications
            const today = new Date().toDateString();
            const todayCount = allNotifications.filter(n => 
                new Date(n.created_at).toDateString() === today
            ).length;
            document.getElementById('todayNotifs').textContent = todayCount;
        }
        
        function filterNotifications(filter) {
            currentFilter = filter;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            // Filter notifications
            let filtered = allNotifications;
            
            if (filter === 'unread') {
                filtered = allNotifications.filter(n => !n.read);
            } else if (filter !== 'all') {
                filtered = allNotifications.filter(n => n.type === filter);
            }
            
            displayNotifications(filtered);
        }
        
        function displayNotifications(notifications) {
            const container = document.getElementById('notificationsList');
            
            if (!notifications || notifications.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üì≠</div>
                        <p style="color: var(--text-secondary);">No notifications to display</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = notifications.map(notif => `
                <div class="notification-item ${notif.read ? '' : 'unread'}" data-id="${notif.id}">
                    <div class="notif-header">
                        <div style="display: flex; align-items: center;">
                            <span class="type-icon">${getTypeIcon(notif.type)}</span>
                            <div>
                                <div class="notif-title">${notif.title}</div>
                                <span class="priority-badge priority-${notif.priority}">
                                    ${notif.priority}
                                </span>
                            </div>
                        </div>
                        <div class="notif-time">${formatTime(notif.created_at)}</div>
                    </div>
                    <div class="notif-message">
                        ${notif.message}
                    </div>
                    <div class="notif-actions">
                        ${!notif.read ? `<a class="notif-action" onclick="markAsRead('${notif.id}')">Mark as Read</a>` : ''}
                        <a class="notif-action" onclick="deleteNotification('${notif.id}')">Delete</a>
                    </div>
                </div>
            `).join('');
        }
        
        function getTypeIcon(type) {
            const icons = {
                'price_alert': 'üí∞',
                'whale_movement': 'üêã',
                'ai_insight': 'ü§ñ',
                'market_update': 'üìä',
                'trade_signal': 'üìà',
                'system': '‚öôÔ∏è'
            };
            return icons[type] || 'üîî';
        }
        
        async function markAsRead(notificationId) {
            try {
                const response = await fetch('/api/notifications/mark-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        notification_id: notificationId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update local state
                    const notif = allNotifications.find(n => n.id === notificationId);
                    if (notif) {
                        notif.read = true;
                    }
                    
                    // Re-render
                    filterNotifications(currentFilter);
                    
                    // Update stats
                    const stats = {
                        total: allNotifications.length,
                        unread: allNotifications.filter(n => !n.read).length
                    };
                    updateStats(stats);
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }
        
        async function markAllAsRead() {
            try {
                const response = await fetch('/api/notifications/mark-all-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Mark all as read locally
                    allNotifications.forEach(n => n.read = true);
                    
                    // Re-render
                    filterNotifications(currentFilter);
                    
                    // Update stats
                    updateStats({
                        total: allNotifications.length,
                        unread: 0
                    });
                }
            } catch (error) {
                console.error('Error marking all as read:', error);
            }
        }
        
        async function deleteNotification(notificationId) {
            if (!confirm('Delete this notification?')) return;
            
            try {
                const response = await fetch('/api/notifications/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        notification_id: notificationId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Remove from local state
                    allNotifications = allNotifications.filter(n => n.id !== notificationId);
                    
                    // Re-render
                    filterNotifications(currentFilter);
                    
                    // Update stats
                    const stats = {
                        total: allNotifications.length,
                        unread: allNotifications.filter(n => !n.read).length
                    };
                    updateStats(stats);
                }
            } catch (error) {
                console.error('Error deleting notification:', error);
            }
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000); // seconds
            
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
            
            return date.toLocaleDateString();
        }
        
        // Auto-refresh every 30 seconds
        setInterval(loadNotifications, 30000);
    </script>
</body>
</html>
